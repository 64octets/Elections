ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4$race=ifelse(state=="General Elecions","General Elecions","State")
x4$race=ifelse(x4$state=="General Elecions","General Elecions","State")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4$race=ifelse(x4$state=="General Elecions","General Elecion","State")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
View(x4)
x4$race=ifelse(x4$state=="General Election","General Election","State")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4$race=ifelse(x4$state=="General Election","National Polls","State Polls")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Spread")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Spread")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Spread")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-15)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(Democratic_name~race)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich"))%>%
ggplot(aes(x=Republican_name,y=Republican_result,fill=Month))+
geom_boxplot()+geom_hline(yintercept=50,linetype=2)+
facet_wrap(~Democratic_name,ncol=1)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich"))%>%
ggplot(aes(x=Republican_name,y=Republican_result,fill=Month))+
geom_boxplot()+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+ggtitle("General Election: Head to Head Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+
ggtitle("General Election: Head to Head Polling /n Average Daily Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+
ggtitle("General Election: Head to Head Polling \n Average Daily Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich"))%>%
ggplot(aes(x=Republican_name,y=Republican_result,fill=Month))+
geom_boxplot()+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+
ggtitle("General Election: Head to Head Polling \n Month Distribution")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top",axis.text.x = element_text(angle = 90))+
ggtitle("General Election: Head to Head Polling \n Average Daily Polling")+
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=factor(Date),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top",axis.text.x = element_text(angle = 90))+
ggtitle("General Election: Head to Head Polling \n Average Daily Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=format(Date,"%m/%d"),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top",axis.text.x = element_text(angle = 90))+
ggtitle("General Election: Head to Head Polling \n Average Daily Polling")
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=format(Date,"%m/%d"),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top",axis.text.x = element_text(angle = 90))+
ggtitle("General Election: Head to Head Polling \n Average Daily Republican Spread")
h2h=function(url){
x=read_html(url)
x1=x%>%html_table(header = T)
names(x1)=seq(1,length(x1))
x2=ldply(x1[seq(2,60,2)],.fun = function(y) y%>%select(-Spread),.id = "id")%>%mutate(id=as.numeric(id))
x3=ldply(x1[seq(1,59,2)],.fun = function(y) data.frame(Date=strptime(names(y[1]),"%A, %B %d")),.id="id")%>%mutate(id=as.numeric(id))
x3=x3%>%left_join(x2,"id")%>%select(-id)
names(x3)[2]="Race"
x4=data.frame(apply(do.call("rbind",lapply(strsplit(x3$Results,","),'[')),2,stringi::stri_trim_both))%>%
mutate_each(funs(name=gsub('[0-9 ]','',.),result=as.numeric(gsub('[^0-9]','',.))))%>%
do(.,cbind(x3%>%select(Date,Poll),.))%>%select(-c(X1,X2))%>%mutate(Month=format(Date,"%Y/%m"))
x4$Democratic_name=x4$Democratic_result=NA
x4$Republican_name=x4$Republican_result=NA
x4$Democratic_name=ifelse(x4$X1_name%in%c("Clinton","Sanders"),x4$X1_name,x4$X2_name)
x4$Democratic_result=ifelse(x4$X1_name%in%c("Clinton","Sanders"),x4$X1_result,x4$X2_result)
x4$Republican_name=ifelse(!x4$X1_name%in%c("Clinton","Sanders"),x4$X1_name,x4$X2_name)
x4$Republican_result=ifelse(!x4$X1_name%in%c("Clinton","Sanders"),x4$X1_result,x4$X2_result)
x4=x4%>%select(-contains("X"))
x4$state=unlist(lapply(strsplit(x3$Race,":"),"[",1))
x4$race=ifelse(x4$state=="General Election","National Polls","State Polls")
plot.trend=x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich"))%>%
ggplot(aes(x=Republican_name,y=Republican_result,fill=Month))+
geom_boxplot()+geom_hline(yintercept=50,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+
ggtitle("General Election: Head to Head Polling \n Month Distribution")
plot.spread=x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich")&as.Date(Date)>=Sys.Date()-30)%>%
group_by(Date,race,Republican_name,Democratic_name)%>%summarise_each(funs(mean),contains("Result"))%>%
ggplot(aes(x=format(Date,"%m/%d"),y=Republican_result-50,fill=Republican_name))+
geom_bar(position="dodge",stat="identity")+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
xlab("Date")+ylab("Republican Spread")+
scale_fill_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top",axis.text.x = element_text(angle = 90))+
ggtitle("General Election: Head to Head Polling \n Average Daily Republican Spread")
return(list(data=x4,plot.trend=plot.trend,plot.spread=plot.spread))
}
h2h.out=h2h("http://www.realclearpolitics.com/epolls/latest_polls/pres_general/")
h2h.out$plot.trend
h2h.out$plot.spread
shiny::runApp('GitHub/Elections/USA2016/shiny')
runApp('GitHub/Elections/USA2016/shiny')
runApp('GitHub/Elections/USA2016/shiny')
runApp('GitHub/Elections/USA2016/shiny')
runApp('GitHub/Elections/USA2016/shiny')
x4%>%filter(Republican_name%in%c("Trump","Cruz","Kasich"))%>%
ggplot(aes(x=Republican_name,y=Republican_result-50,fill=Month))+
geom_boxplot()+geom_hline(yintercept=0,linetype=2)+
facet_grid(race~Democratic_name)+
ylab("Republican Result")+xlab("Republican Candidate")+
scale_colour_discrete(name="Republican Candidate")+
theme_bw()+theme(legend.position="top")+
ggtitle("General Election: Head to Head Polling \n Monthy Polling Distribution")
runApp('GitHub/Elections/USA2016/shiny')
shiny::runApp('GitHub/Elections/USA2016/shiny')
Sys.setlocale(locale="English_US")
Sys.setlocale(category = "LC_TIME",locale="C")
setwd("C:/Users/yoni/Documents/GitHub/Elections/USA2016/shiny")
runApp()
runApp()
runApp()
runApp()
runApp()
url.in=data.frame(Party=c("Republican","Democratic"),
URL=c("http://www.realclearpolitics.com/epolls/latest_polls/gop_pres_primary/",
"http://www.realclearpolitics.com/epolls/latest_polls/dem_pres_primary/"),stringsAsFactors = F)
State.Polls=ddply(url.in,.(Party),.fun = function(df){
x=read_html(df$URL)
x1=x%>%html_table(header = T)
names(x1)=seq(1,length(x1))
x2=ldply(x1[seq(2,60,2)],.fun = function(y) y%>%select(-Spread),.id = "id")%>%mutate(id=as.numeric(id))
x3=ldply(x1[seq(1,59,2)],.fun = function(y) data.frame(Date=strptime(names(y[1]),"%A, %B %d")),.id="id")%>%mutate(id=as.numeric(id))
x3=x3%>%left_join(x2,"id")%>%select(-id)
names(x3)[2]="Race"
x3$State=stringi::stri_trim_both(gsub('Democratic|Republican|Presidential|Primary|Caucus|[0-9]','',x3$Race))
x3$State[grepl('Nomination',x3$State)]='General Election'
x3$id=seq(1,nrow(x3))
x4=ddply(x3,.(id),.fun = function(x.in){
Candidate=unlist(lapply(strsplit(x.in$Results,", ")[[1]],function(x) gsub('[0-9 ]','',x[1])))
Results=unlist(lapply(strsplit(x.in$Results,", ")[[1]],function(x) as.numeric(gsub('[aA-zZ ]','',x[1]))))
x.out=data.frame(Candidate,Results)%>%do(.,filter(.,complete.cases(.)))%>%mutate(Date=x.in$Date,Poll=x.in$Poll,State=x.in$State)
return(x.out)
})%>%select(-id)
return(x4)
})
State.Polls=State.Polls%>%left_join(State.Polls%>%filter(State=="General Election")%>%group_by(Candidate)%>%do(head(.,5))%>%summarise(GenMean=mean(Results),GenSd=sd(Results)),by="Candidate")%>%
left_join(data.frame(State=state.name,State.Abb=state.abb,stringsAsFactors = F),by="State")%>%
mutate(State.Abb=ifelse(is.na(State.Abb),"US",State.Abb))
poll.shiny=State.Polls%>%select(-contains("Gen"))%>%rename(Pollster=Poll)%>%mutate(
#Sample.Type=gsub('[^A-Z]','',Sample),Sample=as.numeric(gsub('[^0-9]','',Sample)),
Date=as.Date(Date),Month=format(Date,"%b"),Weekday=format(Date,"%A"),MonthWeek=whichWeek(Date),
DaysLeft=as.numeric(as.Date("2016-07-25")-Date),
Candidate=as.character(Candidate))
fac_vars=names(poll.shiny)[c(2,6,7,5,1,11,8:10)]
load("DelegatesCurrent.Rdata")
delegate=delegates%>%filter(Date!="-")%>%mutate_each(funs(as.character))
delegate$Delegates=as.numeric(gsub('\\([^)]*\\)','',delegate$Delegates))
delegate$State=gsub('^.{0,2}|[0-9]','',delegate$State)
del.Date=function(x.in){
paste('2016',gsub(x.in[2],'',x.in[1]),x.in[2],sep="-")
}
delegate$Date[delegate$Party=="republican"]=unlist(lapply(strsplit(gsub('[ aA-zZ]','',delegate$Date[delegate$Party=="republican"]),'/'),del.Date))
delegate$Date[delegate$Party=="democratic"]=as.character(as.Date(x = paste(delegate$Date[delegate$Party=="democratic"],"2016"),format = "%B %d %Y"))
delegate$Date=as.Date(delegate$Date)
delegate$Date[is.na(delegate$Date)]=as.Date("2016-03-01")
delegate%>%View
delegate%>%filter(is.na(value))%>%select(State)%>%distinct
delegate%>%filter(value=='')%>%select(State)%>%distinct
delegate%>%filter(value=='')%>%select(State,Date)%>%distinct
delegate%>%filter(value=='')%>%select(State,Date)%>%distinct%>%filter(Date>=Sys.Date())
remaining.states=delegate%>%filter(value=='')%>%select(State,Date)%>%distinct%>%filter(Date>=Sys.Date())
poll.shiny%>%names
poll.shiny%>%filter(State%in%remaining.states$State)%>%View
runApp()
runApp()
runApp()
runApp()
shiny::runGitHub("Elections/","yonicd",subdir="USA2016/shiny")
shiny::runGitHub("yonicd/Elections",subdir="USA2016/shiny")
runApp()
fac_vars
runApp()
runApp()
runApp()
runApp()
library(RSelenium);
RSelenium::startServer()
remDr <- remoteDriver()
delegate.list=vector('list',2)
names(delegate.list)=c("republican","democratic")
StateLinks=delegate.list
for(i in 1:2){
remDr$open(silent = T)
remDr$setTimeout(type = "page load", milliseconds = 50000)
remDr$navigate(paste0("http://www.realclearpolitics.com/epolls/2016/president/",names(delegate.list)[i],"_delegate_count.html"))
out=htmlParse(remDr$getPageSource()[[1]])
StateLinks[[i]]=as.character(getNodeSet(out,'//*[contains(concat( " ", @class, " " ), concat( " ", "state_col", " " ))]//a/@href'))
dataNode=getNodeSet(out,'//*[@id="polling-data-rcp"]//table')
delegate.list[[i]]=readHTMLTable(dataNode[[1]],header = T)
remDr$close()
}
StateLinks.df=ldply(StateLinks,function(x){
state=toupper(substr(gsub("http://www.realclearpolitics.com/epolls/2016/president/",'',x),1,2))
df=data.frame(state.abb=state,url=x,stringsAsFactors = F)},.id = "Party")
delegates=ldply(delegate.list,function(df){
df=df%>%mutate_each(funs(as.character))
#cols=head(names(df),-2)
#if(tail(cols,1)=="Primary/Caucus") cols=cols[1:(length(cols)-1)]
if(!any(names(df)%in%"Primary/Caucus")){
df$`Primary/Caucus`=df$DelegateAllocation
df$DelegateAllocation="Proportional"}
df=df%>%mutate_each(funs(gsub('\u2207|\\*|#','',.)),DelegateAllocation,`Open/Closed`)
df%>%melt(.,id=c("State","Date","Delegates","Primary/Caucus","DelegateAllocation","Open/Closed"))
},.id = "Party")
save(StateLinks.df,delegates,file="DelegatesCurrent.Rdata")
getwd()
runApp()
runApp()
runApp()
State.Roll.Plot
Sys.setlocale(category = "LC_TIME",locale="C")
setwd("C:/Users/yoni/Documents/GitHub/Elections/USA2016/shiny")
whichWeek <- function(aDate) paste0("0",ceiling(as.numeric(format(aDate, "%d"))/7 ))
url.in=data.frame(Party=c("Republican","Democratic"),
URL=c("http://www.realclearpolitics.com/epolls/latest_polls/gop_pres_primary/",
"http://www.realclearpolitics.com/epolls/latest_polls/dem_pres_primary/"),stringsAsFactors = F)
State.Polls=ddply(url.in,.(Party),.fun = function(df){
x=read_html(df$URL)
x1=x%>%html_table(header = T)
names(x1)=seq(1,length(x1))
x2=ldply(x1[seq(2,60,2)],.fun = function(y) y%>%select(-Spread),.id = "id")%>%mutate(id=as.numeric(id))
x3=ldply(x1[seq(1,59,2)],.fun = function(y) data.frame(Date=strptime(names(y[1]),"%A, %B %d")),.id="id")%>%mutate(id=as.numeric(id))
x3=x3%>%left_join(x2,"id")%>%select(-id)
names(x3)[2]="Race"
x3$State=stringi::stri_trim_both(gsub('Democratic|Republican|Presidential|Primary|Caucus|[0-9]','',x3$Race))
x3$State[grepl('Nomination',x3$State)]='General Election'
x3$id=seq(1,nrow(x3))
x4=ddply(x3,.(id),.fun = function(x.in){
Candidate=unlist(lapply(strsplit(x.in$Results,", ")[[1]],function(x) gsub('[0-9 ]','',x[1])))
Results=unlist(lapply(strsplit(x.in$Results,", ")[[1]],function(x) as.numeric(gsub('[aA-zZ ]','',x[1]))))
x.out=data.frame(Candidate,Results)%>%do(.,filter(.,complete.cases(.)))%>%mutate(Date=x.in$Date,Poll=x.in$Poll,State=x.in$State)
return(x.out)
})%>%select(-id)
return(x4)
})
State.Polls=State.Polls%>%left_join(State.Polls%>%filter(State=="General Election")%>%group_by(Candidate)%>%do(head(.,5))%>%summarise(GenMean=mean(Results),GenSd=sd(Results)),by="Candidate")%>%
left_join(data.frame(State=state.name,State.Abb=state.abb,stringsAsFactors = F),by="State")%>%
mutate(State.Abb=ifelse(is.na(State.Abb),"US",State.Abb))
poll.shiny=State.Polls%>%select(-contains("Gen"))%>%rename(Pollster=Poll)%>%mutate(
#Sample.Type=gsub('[^A-Z]','',Sample),Sample=as.numeric(gsub('[^0-9]','',Sample)),
Date=as.Date(Date),Month=format(Date,"%b"),Weekday=format(Date,"%A"),MonthWeek=whichWeek(Date),
DaysLeft=as.numeric(as.Date("2016-07-25")-Date),
Candidate=as.character(Candidate))
#sample.avg=poll.shiny%>%group_by(Pollster,Sample.Type)%>%summarise(Sample.Mean=floor(mean(Sample,na.rm = T)))
# poll.shiny=poll.shiny%>%left_join(sample.avg,by=c("Pollster","Sample.Type"))%>%
#   mutate(Results=Results,Sample=ifelse(is.na(Sample),Sample.Mean,Sample),
#          Sample.Error=100*1/sqrt(Sample),
#          DaysLeft=as.numeric(as.Date("2016-07-25")-Date))%>%select(-Sample.Mean)%>%
#   filter(Sample.Type%in%c("LV","RV"))
# poll.shiny$Sample.Type=factor(poll.shiny$Sample.Type,labels=c("Likely Voter","Registered Voter"))
fac_vars=names(poll.shiny)[c(2,6,7,5,1,11,8:10)]
load("DelegatesCurrent.Rdata")
delegate=delegates%>%filter(Date!="-")%>%mutate_each(funs(as.character))
delegate$Delegates=as.numeric(gsub('\\([^)]*\\)','',delegate$Delegates))
delegate$State=gsub('^.{0,2}|[0-9]','',delegate$State)
del.Date=function(x.in){
paste('2016',gsub(x.in[2],'',x.in[1]),x.in[2],sep="-")
}
delegate$Date[delegate$Party=="republican"]=unlist(lapply(strsplit(gsub('[ aA-zZ]','',delegate$Date[delegate$Party=="republican"]),'/'),del.Date))
delegate$Date[delegate$Party=="democratic"]=as.character(as.Date(x = paste(delegate$Date[delegate$Party=="democratic"],"2016"),format = "%B %d %Y"))
delegate$Date=as.Date(delegate$Date)
delegate$Date[is.na(delegate$Date)]=as.Date("2016-03-01")
remaining.states=delegate%>%filter(value=='')%>%select(State,Date)%>%distinct%>%filter(Date>=Sys.Date())
rm.cand=c("Christie","Fiorina","Carson","Bush","Rubio")
State.roll=State.Polls%>%filter(!Candidate%in%rm.cand)%>%arrange(Party,Candidate,Date)%>%
group_by(Date,Party,Candidate)%>%summarise_each(funs(mean),Results)%>%group_by(Party,Candidate)%>%
do(.,data.frame(roll.sd=zoo:::rollapplyr(.$Results,width=7,FUN=sd,fill=NA),roll.mean=zoo:::rollapplyr(.$Results,width=7,FUN=mean,fill=NA)))
State.roll$Date=(State.Polls%>%filter(!Candidate%in%rm.cand)%>%select(Candidate,Date)%>%arrange(Candidate,Date)%>%distinct)$Date
state.roll.plot=State.roll%>%filter(!is.na(roll.mean))%>%rename(value=roll.mean,sd=roll.sd)%>%mutate(type="Trend Index")
delegate.plot=delegate%>%mutate(value=as.numeric(value))%>%filter(!is.na(value)&variable!="Rubio")%>%
group_by(Party,variable,Date)%>%summarise_each(funs(sum),value)%>%group_by(variable)%>%mutate(c.value=cumsum(value))%>%
select(Party,Candidate=variable,Date,value=c.value)%>%
mutate(type="Delegate Count",sd=NA,Party=ifelse(Party=="republican","Republican","Democratic"))
firstPlot=rbind(state.roll.plot,delegate.plot)
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot
dev.off()
dev.off()
dev.off()
State.Roll.Plot
ggplotly()
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
#geom_text(hjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
ggplotly(State.Roll.Plot)
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
#geom_text(hjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+
theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index. The ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
ggplotly(State.Roll.Plot)
runApp()
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.3,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),size=2,data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.3,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),size=2,data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.3,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),size=2,data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),linetype=3,data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.3,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),size=2,data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),linetype=2,data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.3,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
State.Roll.Plot=
firstPlot%>%ggplot(aes(x=Date))+
geom_step(show.legend=F,aes(y=value,colour=Candidate),size=2,data=firstPlot%>%filter(type=="Delegate Count"))+
geom_line(aes(y=value,group=Candidate),linetype=2,data=firstPlot%>%filter(type=="Trend Index"))+
geom_ribbon(aes(ymin=value-sd,ymax=value+sd,fill=Candidate),alpha=.5)+
geom_hline(color="red",linetype=2,size=1,aes(yintercept=Threshold),data=data.frame(Party=c("Democratic","Republican"),Threshold=c(2382,1237),type=rep("Delegate Count",2)))+
geom_text(hjust=.5,vjust=-.3,show.legend = F,aes(y=value,label=floor(value)),data=firstPlot%>%group_by(type,Party,Candidate)%>%do(.,tail(.,1)))+
facet_grid(type~Party,scales="free_y")+theme_bw()+theme(legend.position="top")+
ggtitle("Candidate Delegate Count and Polling Trend Index \n Ribbon represents moving average +/- 1 moving standard deviation on a 7 day window")+
ylab("Percent                          Delegates")
State.Roll.Plot
runApp()
runApp()
