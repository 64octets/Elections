View(temp,Encoding="utf-8")
View
.rs.callAs(temp)
options(shiny.usecairo)
options("")
options("shiny.usecairo")
options()
localeToCharset()
options(encoding = 'UTF-8')
localeToCharset()
Sys.setlocale("LC_ALL", x[2])
temp="יוני"
temp
View(temp)
options(encoding = 'UTF-8')
Sys.getlocale()
options(encoding = 'Windows-1255.UTF-8')
temp="יוני"
temp
View(temp)
options(encoding = 'native.enc')
Sys.getlocale()
Encoding()
Encoding
Encoding(temp)
iconv(temp,to = "UTF-8")
View(iconv(temp,to = "UTF-8"))
temp=iconv(temp,to = "UTF-8")
temp
View(temp)
enc2native(temp)
View(enc2native(temp))
View(enc2utf8(temp))
temp=enc2utf8(temp)
temp
View(temp)
Sys.localeconv()
hills.lm <- lm(log(time) ~ log(climb)+log(dist), data=hills)
require(MASS)
hills.lm <- lm(log(time) ~ log(climb)+log(dist), data=hills)
terms(hills.lm)
x=terms(hills.lm)
x
attr(x,"predvars")
attr(x,"predvars")[1]
attr(x,"predvars")[[1]]
attr(x,"predvars")[[1]][1]
attr(x,"predvars")
class(attr(x,"predvars"))
x
attr(x,"term.labels")
attr(x,"term.labels")[1]
attr(x,"term.labels")[2]
attr(terms(hills.lm),"term.labels")[2]
attr(terms(hills.lm),"term.labels")[1]
termplot(hills.lm)
library(png);library(grid);library(ggplot2)
setwd("C:\\Users\\yoni\\Documents\\GitHub\\Elections")
img=readPNG(system.file("img","\www\PADqr.png",package("png")))
img=readPNG(system.file("img","\\www\\PADqr.png",package("png")))
img=readPNG(system.file("img","\\www\\PADqr.png",package"png"))
getwd()
img=readPNG(system.file("img","PADqr.png",package"png"))
img=readPNG(system.file("PADqr.png",package"png"))
img=readPNG(system.file("C:/Users/yoni/Documents/GitHub/Elections/PADqr.png",package"png"))
img=readPNG(system.file("C:/Users/yoni/Documents/GitHub/Elections/PADqr.png"))
img=readPNG(system.file("PADqr.png"))
system.file("PADqr.png")
img <- readPNG(system.file("img", "Rlogo.png", package="png"))
rm(img)
img=readPNG("PADqr.png",F)
g=rasterGrob(img,interpolate=T)
qplot(1:10,1:10,geom="blank")+annotation_custom(g,xmin=Inf,ymax=-Inf)+geom_point()
img=readPNG("PADqr.png",info = F)
g=rasterGrob(img,interpolate=T)
qplot(1:10,1:10,geom="blank")+annotation_custom(g,xmin=Inf,ymax=-Inf)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,xmin=Inf,ymax=-Inf)+geom_point()
img=readPNG("PADqr.png",native = F)
class(img)
img=readPNG("PADqr.png",native = T)
dim(img)[1]
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,4]*.2),nrow=dim(img)[1])
rm(list=ls())
m=readPNG("PADqr.png",native = T)
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,4]*.2),nrow=dim(m)[1])
dim(m)[1]
dim(m)
w=matrix(rgb(m[,,1],m[,,2]*.2),nrow=dim(m)[1])
w=matrix(rgb(m[,1],m[,2]*.2),nrow=dim(m)[1])
g=rasterGrob(m,interpolate = T)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,xmin=Inf,ymax=-Inf)+geom_point()
img <- readPNG(system.file("img", "Rlogo.png", package="png"))
m=readPNG("PADqr.png")
dim(m)
m=readImage("PADqr.png")
m=readPNG("PADqr.png",native = T,info = T)
m=readPNG("PADqr.png",native = T,info = T)
m=readPNG("PADqr.png")
g=rasterGrob(m)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,xmax=1,xmin=-Inf,ymax=Inf,ymin=1)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,xmax=Inf,xmin=-Inf,ymax=Inf,ymin=1)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = 10,y = 1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = 1,y = 1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = .05,y = .9)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = 1,y = .9)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = .5,y = .9)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
g=rasterGrob(m,x = .5,y = .8)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g,
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
dim(m)
w=matrix(rgb(m[,,1],m[,,2],m[,,3]*.2),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,3]*.2),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,3]*.5),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,3]*.1),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,3]*.9),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
w=matrix(rgb(m[,,1],m[,,2],m[,,3],m[,,1]*.9),nrow=dim(m)[1])
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(w,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y = .8),
xmax=2,xmin=-Inf,ymax=Inf,ymin=2)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y = .8),
xmax=1,xmin=-Inf,ymax=Inf,ymin=1)+geom_point()
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = 1,y = 1),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = 1,y = .1),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = 1,y = -Inf),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = 1,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .01,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .05,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .05,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .075,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .1,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .2,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .25,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y = .01),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y = .0075),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y = .001),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =0),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =0),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=2,xmin=-Inf,ymax=Inf,ymin=2)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=1.5,xmin=-Inf,ymax=Inf,ymin=1.5)
qplot(1:10,1:10,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1.25)
shiny::runApp()
shiny::runApp()
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = .75,y =0),xmax=1.75,xmin=-Inf,ymax=Inf,ymin=1.25)
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = .075,y =0),xmax=1.75,xmin=-Inf,ymax=Inf,ymin=1.25)
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = 1,y =0),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = 1,y =0),xmax=.5,xmin=-Inf,ymax=Inf,ymin=.5)
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =0),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1:2,1:2,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1,1,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1,1,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1,xmin=-Inf,ymax=Inf,ymin=1)
qplot(1,1,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1,xmin=-Inf,ymax=Inf,ymin=.75)
qplot(1,1,geom="blank")+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")++theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank())
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank())+
annotation_custom(g=rasterGrob(m,x = 1,y =1),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank())+
annotation_custom(g=rasterGrob(m,x = .75,y =.75),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.tick=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.background=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
shiny::runApp()
input=data.frame(poll=c(1,5))
a=x%>%mutate(Dateid=factor(Date),DatePoll=factor(paste(Dateid,Pollsterid,sep=".")))
nt=tail(levels(a$DatePoll),input$poll[2])
nt=tail(nt,input$poll[2]-input$poll[1]-1)
a=a%>%filter(DatePoll%in%nt)
input=data.frame(Boot=50)
a$nr=1:nrow(a)
out=ddply(a%>%select(Mandates.lb,Mandates.ub,nr),.(nr),
.fun = function(df) {
B=input$Boot
mout=cbind(as.matrix(sample(as.numeric(df[1]):as.numeric(df[2]),B,replace=T),ncol=1),1:B)
})
names(out)[-1]=c("rMandates","bs.id")
a=left_join(out,a,by=c("nr"))
a=a%>%group_by(bs.id,Party)%>%summarise_each(funs(mean(.,na.rm = T)),Mandates,rMandates)%>%
mutate(rMandates=ifelse(floor(rMandates)<4,0,floor(rMandates)),
Mandates=ifelse(floor(Mandates)<4,0,floor(Mandates)))%>%arrange(Party)
df=melt(a,id=c("bs.id","Party"),value.name = "base")
df$base=df$base+runif(nrow(df))*1e-3
df=df%>%group_by(bs.id,variable)%>%
mutate(base=120*base/sum(base),
base.floor=floor(base),
pct=base/(base.floor+1),
add=0,id=0,
share=factor(Party,labels=c(1,1,2,3,4,5,6,6,2,7,3)))
#hagenbach-bischoff system
df=ddply(df,.(bs.id,variable),.fun = function(df){
for(i in (1:(120-sum(df$base.floor)))){
y1=(df%>%group_by(share)%>%summarise(group_pct=sum(base)/(sum(base.floor)+1))%>%filter(group_pct==max(group_pct)))$share
id=df$pct%in%max(df$pct[df$share==y1])
df$id[id]=i
df$base.floor[id]=df$base.floor[id]+1
df$add[id]=df$add[id]+1
df$pct[id]=df$base[id]/(df$base.floor[id]+1)}
return(df)
})
Party.En=x%>%filter(Election==2015)%>%select(Party,Party.En)%>%unique
df=left_join(df,Party.En,by="Party")
fill_var="Party"
pos="dodge"
yint=4
b.id=sample(1:input$Boot,1)
base.lvl=df%>%filter(variable=="rMandates")%>%count(Party.En,Party,base.floor)
txt.lvl=df%>%filter(variable=="Mandates")%>%group_by(Party.En,Party)%>%summarise(base.floor=floor(mean(base.floor)))
txt.lvl=left_join(txt.lvl,base.lvl,by=c("Party.En","Party","base.floor"))
input$lang.sim=".En"
str_fill=paste0("Party",input$lang.sim)
if(input$lang.sim==""){
xl="מנדטים"
yl=""
ttl=paste("התפלגות סימולציה לחלוקה סופית של מנדטים לאחר אחוז החסימה וסיווג עודפים לפי מפלגה",
"משולש מהווה חציון המנדטים למפלגה על פי הסקרים בפועל",sep="\n")
nm="מפלגה"
}else{
xl="Mandates"
yl=""
ttl="Distribution of Simulated of Mandate Results Conditioned on Mandate Threshold and Surplus Vote Agreements \n Triangle shows the Median Published Result"
nm="Party"
}
base.lvl$n=base.lvl$n/as.numeric(input$Boot)
txt.lvl$n=txt.lvl$n/as.numeric(input$Boot)
p=ggplot(base.lvl)+
geom_bar(aes_string(x="factor(base.floor)",y="n",fill=str_fill),stat="identity",position = "dodge")+
geom_point(aes(x=factor(base.floor),y=n+.02),size=3,shape=17,data=txt.lvl)+
facet_wrap(as.formula(paste0("~",str_fill)),scales="free_x")+theme_bw()+
ggtitle(ttl)+ylab(yl)+xlab(xl)+scale_fill_discrete(name=nm)+scale_y_continuous(label=percent)
p
m=readPNG("PADqr.png")
p1=ggplotGrob(p)
p2=ggplotGrob(
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
p=gtable::gtable_add_grob(p1,p2,t=8,l=7)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=9,l=7)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=12,l=7)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=12,l=12)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=12,l=11)
grid.newpage()
grid.draw(p)
p=ggplot(base.lvl)+
geom_bar(aes_string(x="factor(base.floor)",y="n",fill=str_fill),stat="identity",position = "dodge")+
geom_point(aes(x=factor(base.floor),y=n+.02),size=3,shape=17,data=txt.lvl)+
facet_wrap(as.formula(paste0("~",str_fill)),scales="free_x")+theme_bw()+
ggtitle(ttl)+ylab(yl)+xlab(xl)+scale_fill_discrete(name=nm)+scale_y_continuous(label=percent)
m=readPNG("PADqr.png")
p1=ggplotGrob(p)
p2=ggplotGrob(
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
p=gtable::gtable_add_grob(p1,p2,t=12,l=8)
grid.newpage()
grid.draw(p)
library(png);library(grid);library(ggplot2)
m=readPNG("PADqr.png")
qplot(1,1,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
qplot(1,1,geom="blank")+theme_bw()+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
p=gtable::gtable_add_grob(p1,p2,t=12,l=10)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=12,l=14)
grid.newpage()
grid.draw(p)
p=gtable::gtable_add_grob(p1,p2,t=12,l=13)
grid.newpage()
grid.draw(p)
m=readPNG("PADqr.png")
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
p2=ggplotGrob(
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
p=gtable::gtable_add_grob(p1,p2,t=12,l=13)
grid.newpage()
grid.draw(p)
shiny::runApp()
shiny::runApp()
class(p)
input=data.frame(poll=c(1,5))
a=x%>%mutate(Dateid=factor(Date),DatePoll=factor(paste(Dateid,Pollsterid,sep=".")))
nt=tail(levels(a$DatePoll),input$poll[2])
nt=tail(nt,input$poll[2]-input$poll[1]-1)
a=a%>%filter(DatePoll%in%nt)
a$nr=1:nrow(a)
input=data.frame(Boot=50)
out=ddply(a%>%select(Mandates.lb,Mandates.ub,nr),.(nr),
.fun = function(df) {
B=input$Boot
mout=cbind(as.matrix(sample(as.numeric(df[1]):as.numeric(df[2]),B,replace=T),ncol=1),1:B)
})
names(out)[-1]=c("rMandates","bs.id")
a=left_join(out,a,by=c("nr"))
a=a%>%group_by(bs.id,Party)%>%summarise_each(funs(mean(.,na.rm = T)),Mandates,rMandates)%>%
mutate(rMandates=ifelse(floor(rMandates)<4,0,floor(rMandates)),
Mandates=ifelse(floor(Mandates)<4,0,floor(Mandates)))%>%arrange(Party)
df=melt(a,id=c("bs.id","Party"),value.name = "base")
df$base=df$base+runif(nrow(df))*1e-3
df=df%>%group_by(bs.id,variable)%>%
mutate(base=120*base/sum(base),
base.floor=floor(base),
pct=base/(base.floor+1),
add=0,id=0,
share=factor(Party,labels=c(1,1,2,3,4,5,6,6,2,7,3)))
#hagenbach-bischoff system
df=ddply(df,.(bs.id,variable),.fun = function(df){
for(i in (1:(120-sum(df$base.floor)))){
y1=(df%>%group_by(share)%>%summarise(group_pct=sum(base)/(sum(base.floor)+1))%>%filter(group_pct==max(group_pct)))$share
id=df$pct%in%max(df$pct[df$share==y1])
df$id[id]=i
df$base.floor[id]=df$base.floor[id]+1
df$add[id]=df$add[id]+1
df$pct[id]=df$base[id]/(df$base.floor[id]+1)}
return(df)
})
Party.En=x%>%filter(Election==2015)%>%select(Party,Party.En)%>%unique
df=left_join(df,Party.En,by="Party")
fill_var="Party"
pos="dodge"
yint=4
b.id=sample(1:input$Boot,1)
input$lang.sim=".En"
df=lin$df.full
base.lvl=df%>%filter(variable=="rMandates")%>%count(Party.En,Party,base.floor)
txt.lvl=df%>%filter(variable=="Mandates")%>%group_by(Party.En,Party)%>%summarise(base.floor=floor(mean(base.floor)))
txt.lvl=left_join(txt.lvl,base.lvl,by=c("Party.En","Party","base.floor"))
str_fill=paste0("Party",input$lang.sim)
if(input$lang.sim==""){
xl="מנדטים"
yl=""
ttl=paste("התפלגות סימולציה לחלוקה סופית של מנדטים לאחר אחוז החסימה וסיווג עודפים לפי מפלגה",
"משולש מהווה חציון המנדטים למפלגה על פי הסקרים בפועל",sep="\n")
nm="מפלגה"
}else{
xl="Mandates"
yl=""
ttl="Distribution of Simulated of Mandate Results Conditioned on Mandate Threshold and Surplus Vote Agreements \n Triangle shows the Median Published Result"
nm="Party"
}
base.lvl$n=base.lvl$n/as.numeric(input$Boot)
txt.lvl$n=txt.lvl$n/as.numeric(input$Boot)
p=ggplot(base.lvl)+
geom_bar(aes_string(x="factor(base.floor)",y="n",fill=str_fill),stat="identity",position = "dodge")+
geom_point(aes(x=factor(base.floor),y=n+.02),size=3,shape=17,data=txt.lvl)+
facet_wrap(as.formula(paste0("~",str_fill)),scales="free_x")+theme_bw()+
ggtitle(ttl)+ylab(yl)+xlab(xl)+scale_fill_discrete(name=nm)+scale_y_continuous(label=percent)
m=readPNG("PADqr.png")
p1=ggplotGrob(p)
p2=ggplotGrob(
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
text=element_blank(),axis.ticks=element_blank())+
annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
libarary(gridExtra)
library(gridExtra)
arrangeGrob(p1,p2)
arrangeGrob(p1,p2,plot=T)
class(p1)
class(p2)
p0=arrangeGrob(p1,p2)
grid.arrange(p0)
class(grid.arrange(p0))
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf))
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1.25,xmin=-Inf,ymax=Inf,ymin=1.25)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=.25,xmin=-Inf,ymax=Inf,ymin=.25)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=Inf,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.5),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .5,y =1),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .5,y =.95),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = .95,y =.95),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.95),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.75,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 27,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=.75,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-1,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-10,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=.75,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=.5,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1.5,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =1),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.75),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.8),xmax=1,xmin=-Inf,ymax=1,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.8),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = 20),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = .2),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = 1),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = .75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = .75,height=.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width = .5),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.95,width = .5),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.9,width = .5),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.9,width = .75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9,width = .75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
qplot(1,1,geom="blank")+theme_bw()+theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
#                                                                               text=element_blank(),axis.ticks=element_blank())
annotation_custom(g=rasterGrob(m,x = 4.5,y =.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
m=readPNG("PADqr.png")
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width=.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.9,width=.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.9,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 5,y =.85,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.95,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.75,y =.9,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.8,y =.9,width=.7),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.75),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.5,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.75,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.7,y =.8),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.6,y =.9),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+annotation_custom(g=rasterGrob(m,x = 4.6,y =.85),xmax=1,xmin=-Inf,ymax=Inf,ymin=-Inf)
p+xlab("Mandates \n http:\\yonicd.shinyapps.io\Elections")
"http:\\\\yonicd.shinyapps.io\\Elections"
"http:\\yonicd.shinyapps.io\Elections"
"http://yonicd.shinyapps.io/Elections"
normalizePath("http://yonicd.shinyapps.io/Elections","\")
normalizePath("http://yonicd.shinyapps.io/Elections","\\")
"http:\\yonicd.shinyapps.io_Elections"
paste("http:\\yonicd.shinyapps.io","Elections",sep="\")
a
paste("http:\\yonicd.shinyapps.io","Elections",sep="\\")
paste("http:\\\\yonicd.shinyapps.io","Elections",sep="\\")
"http:\\\\yonicd.shinyapps.io\\Elections"
p+xlab("Mandates \n http:\\\\yonicd.shinyapps.io\\Elections")
p+xlab("Mandates \n \n http:\\\\yonicd.shinyapps.io\\Elections")
shiny::runApp()
class(x$Election)
shiny::runApp()
shiny::runApp()
names(x)
shiny::runApp()
shiny::runApp()
shiny::runApp()
shiny::runApp()
Party
input=data.frame(Election==2015)
input=data.frame(Election=2015)
Party=x%>%filter(Election%in%input$Election)%>%select(Partyid,Party,Party.En)%>%unique
paste(Party[,2],Party[,3],sep=":")
paste(Party[,2],Party[,3],sep=":")%>%View
paste(Party[,3],Party[,2],sep=":")%>%View
shiny::runApp()
shiny::runApp()
shiny::runApp()
